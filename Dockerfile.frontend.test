# TEST/DIAGNOSTIC Dockerfile - Frontend
# This skips the build step but verifies everything else

FROM node:18-alpine AS builder

# Install git
RUN apk add --no-cache git

# Set Node memory
ENV NODE_OPTIONS="--max-old-space-size=4096"

WORKDIR /app

# Copy package files
COPY package.json package-lock.json ./

# Install dependencies
RUN npm install --legacy-peer-deps

# Copy application source
COPY . .

# ============================================
# DIAGNOSTIC CHECKS (instead of building)
# ============================================

# Check 1: Verify Node and NPM versions
RUN echo "========================================" && \
    echo "CHECK 1: Node.js and NPM versions" && \
    echo "========================================" && \
    node --version && \
    npm --version && \
    echo ""

# Check 2: Verify all files are present
RUN echo "========================================" && \
    echo "CHECK 2: Required files present?" && \
    echo "========================================" && \
    ls -la && \
    echo "" && \
    echo "package.json exists:" && test -f package.json && echo "✓ YES" || echo "✗ NO" && \
    echo "vite.config.js exists:" && test -f vite.config.js && echo "✓ YES" || echo "✗ NO" && \
    echo "index.html exists:" && test -f index.html && echo "✓ YES" || echo "✗ NO" && \
    echo "src/ directory exists:" && test -d src && echo "✓ YES" || echo "✗ NO" && \
    echo "public/ directory exists:" && test -d public && echo "✓ YES" || echo "✗ NO" && \
    echo ""

# Check 3: List installed dependencies
RUN echo "========================================" && \
    echo "CHECK 3: Installed dependencies" && \
    echo "========================================" && \
    npm list --depth=0 || echo "Some peer dependency warnings (usually OK)" && \
    echo ""

# Check 4: Verify critical dependencies
RUN echo "========================================" && \
    echo "CHECK 4: Critical dependencies installed?" && \
    echo "========================================" && \
    npm list vite && \
    npm list react && \
    npm list react-dom && \
    npm list @vitejs/plugin-react && \
    echo ""

# Check 5: Check src/ directory contents
RUN echo "========================================" && \
    echo "CHECK 5: Source files in src/" && \
    echo "========================================" && \
    ls -la src/ && \
    echo ""

# Check 6: Verify vite.config.js syntax
RUN echo "========================================" && \
    echo "CHECK 6: Vite config file" && \
    echo "========================================" && \
    cat vite.config.js && \
    echo ""

# Check 7: Verify package.json scripts
RUN echo "========================================" && \
    echo "CHECK 7: NPM scripts available" && \
    echo "========================================" && \
    cat package.json | grep -A 10 '"scripts"' && \
    echo ""

# Check 8: Test if vite command is available
RUN echo "========================================" && \
    echo "CHECK 8: Vite CLI available?" && \
    echo "========================================" && \
    npx vite --version && \
    echo ""

# Check 9: Try to import vite.config.js (check for syntax errors)
RUN echo "========================================" && \
    echo "CHECK 9: Vite config can be loaded?" && \
    echo "========================================" && \
    node -e "import('./vite.config.js').then(() => console.log('✓ Config loads OK')).catch(e => {console.log('✗ Config error:', e.message); process.exit(1)})" && \
    echo ""

# Check 10: Disk space and memory
RUN echo "========================================" && \
    echo "CHECK 10: System resources" && \
    echo "========================================" && \
    df -h . && \
    echo "" && \
    free -m 2>/dev/null || echo "Memory info not available in Alpine" && \
    echo ""

# Check 11: Environment variables
RUN echo "========================================" && \
    echo "CHECK 11: Environment variables" && \
    echo "========================================" && \
    echo "NODE_OPTIONS=$NODE_OPTIONS" && \
    echo "PATH=$PATH" && \
    echo "PWD=$(pwd)" && \
    echo ""

# ============================================
# FINAL SUMMARY
# ============================================
RUN echo "========================================" && \
    echo "✓ ALL DIAGNOSTIC CHECKS PASSED!" && \
    echo "========================================" && \
    echo "" && \
    echo "Everything is ready for build." && \
    echo "If this succeeds, the problem is in 'npm run build' itself." && \
    echo "" && \
    echo "Next step: Check the actual Vite build error." && \
    echo ""

# Create a dummy output for nginx stage to work
RUN mkdir -p build && \
    echo '<!DOCTYPE html><html><body><h1>Diagnostic Test Passed</h1><p>All checks completed successfully!</p></body></html>' > build/index.html

# Stage 2: Serve with nginx (just to complete the build)
FROM nginx:alpine

COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=builder /app/build /usr/share/nginx/html

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
